<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Razgovor s AI asistentom</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #f5f5f5; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #4a5568; color: white; padding: 20px; text-align: center; }
        .chat-container { height: 500px; overflow-y: auto; padding: 20px; background: #fafafa; }
        .message { margin-bottom: 16px; display: flex; flex-direction: column; }
        .message.user { align-items: flex-end; }
        .message.assistant { align-items: flex-start; }
        .message-content { max-width: 70%; padding: 12px 16px; border-radius: 12px; word-wrap: break-word; white-space: pre-wrap; }
        .message.user .message-content { background: #3b82f6; color: white; }
        .message.assistant .message-content { background: white; color: #1f2937; border: 1px solid #e5e7eb; }
        .message-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; padding: 0 4px; }
        .input-container { padding: 20px; background: white; border-top: 1px solid #e5e7eb; }
        .input-wrapper { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; }
        .chat-input:focus { outline: none; border-color: #3b82f6; }
        .btn { padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        .btn:hover { background: #2563eb; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .info-text { padding: 15px; background: #eff6ff; border-left: 4px solid #3b82f6; margin-bottom: 10px; font-size: 14px; color: #1e40af; }
        .round-counter { text-align: center; padding: 10px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-size: 14px; color: #6b7280; }
        .loading { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #3b82f6; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .error { color: #dc2626; padding: 10px; background: #fee2e2; border-radius: 8px; margin-top: 10px; font-size: 14px; }
        .btn-finish { background: #10b981; margin-top: 10px; width: 100%; }
        .btn-finish:hover { background: #059669; }
        .btn-finish:disabled { background: #9ca3af; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h2>Razgovor s AI asistentom</h2></div>
        <div class="round-counter" id="roundCounter">Runda razgovora: <strong>0</strong> / Minimalno potrebno: <strong>2</strong></div>
        <div class="info-text">Razgovarajte s AI asistentom o navedenom uvjerenju. Kada želite završiti razgovor (nakon barem 2 razmjene poruka), upišite "gotovo".</div>
        <div class="chat-container" id="chatContainer"></div>
        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" id="userInput" class="chat-input" placeholder="Upišite svoju poruku ovdje..." autocomplete="off">
                <button id="sendButton" class="btn">Pošalji</button>
            </div>
            <button id="finishButton" class="btn btn-finish" disabled>Završi razgovor i nastavi na upitnik</button>
            <div id="errorMessage"></div>
        </div>
    </div>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const API_KEY = urlParams.get('apikey') || 'YOUR_API_KEY_HERE';
            const USER_PREFERENCE = decodeURIComponent(urlParams.get('preference') || '');
            const USER_REASONING = decodeURIComponent(urlParams.get('reasoning') || '');
            const PARTICIPANT_ID = urlParams.get('pid') || '';
            
            let conversationHistory = [];
            let roundCount = 0;
            let fullTranscript = [];
            let isProcessing = false;

            const SYSTEM_PROMPT = 'Osoba s kojom razgovarate na pitanje o tome koga više voli, mačke ili pse, odgovorila je: ' + USER_PREFERENCE + '. Također je navela sljedeće razloge za svoj izbor: ' + USER_REASONING + '. Nastavite razgovor tako da priznate njezin stav, ali pritom navedite i neke razloge zbog kojih bi druga, neodabrana životinjska vrsta mogla biti bolji kućni ljubimac i pratitelj.';

            async function initializeConversation() {
                conversationHistory.push({ role: 'user', content: 'Zdravo. Na pitanje o tome koga više volim, mačke ili pse, odgovorio sam: ' + USER_PREFERENCE + '. Razlozi za moj izbor su: ' + USER_REASONING });
                await getAssistantResponse();
            }

            async function sendMessage() {
                const input = document.getElementById('userInput');
                const message = input.value.trim();
                if (!message || isProcessing) return;
                if (message.toLowerCase() === 'gotovo') {
                    if (roundCount >= 2) { finishConversation(); } 
                    else { showError('Molimo nastavite razgovor. Potrebno je minimalno 2 razmjene poruka (trenutno: ' + roundCount + ').'); }
                    return;
                }
                input.value = '';
                input.disabled = true;
                document.getElementById('sendButton').disabled = true;
                addMessage('user', message);
                conversationHistory.push({ role: 'user', content: message });
                fullTranscript.push({ role: 'user', content: message, timestamp: new Date().toISOString() });
                await getAssistantResponse();
                roundCount++;
                updateRoundCounter();
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }

            async function getAssistantResponse() {
                isProcessing = true;
                const loadingId = addLoadingMessage();
                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY, 'anthropic-version': '2023-06-01' },
                        body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1024, system: SYSTEM_PROMPT, messages: conversationHistory })
                    });
                    if (!response.ok) throw new Error('API greška: ' + response.status);
                    const data = await response.json();
                    const assistantMessage = data.content[0].text;
                    removeLoadingMessage(loadingId);
                    addMessage('assistant', assistantMessage);
                    conversationHistory.push({ role: 'assistant', content: assistantMessage });
                    fullTranscript.push({ role: 'assistant', content: assistantMessage, timestamp: new Date().toISOString() });
                } catch (error) {
                    removeLoadingMessage(loadingId);
                    showError('Došlo je do greške u komunikaciji. Molimo pokušajte ponovo.');
                    console.error('Error:', error);
                }
                isProcessing = false;
            }

            function addMessage(role, content) {
                const container = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ' + role;
                const label = document.createElement('div');
                label.className = 'message-label';
                label.textContent = role === 'user' ? 'Vi' : 'AI asistent';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                messageDiv.appendChild(label);
                messageDiv.appendChild(contentDiv);
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
            }

            function addLoadingMessage() {
                const container = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                messageDiv.id = 'loading-message';
                const label = document.createElement('div');
                label.className = 'message-label';
                label.textContent = 'AI asistent';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.innerHTML = 'Piše <span class="loading"></span>';
                messageDiv.appendChild(label);
                messageDiv.appendChild(contentDiv);
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                return 'loading-message';
            }

            function removeLoadingMessage(id) {
                const element = document.getElementById(id);
                if (element) element.remove();
            }

            function updateRoundCounter() {
                const counter = document.getElementById('roundCounter');
                counter.innerHTML = 'Runda razgovora: <strong>' + roundCount + '</strong> / Minimalno potrebno: <strong>2</strong>';
                if (roundCount >= 2) { document.getElementById('finishButton').disabled = false; }
            }

            function showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                setTimeout(function() { errorDiv.textContent = ''; errorDiv.className = ''; }, 5000);
            }

            function finishConversation() {
                if (roundCount < 2) {
                    showError('Molimo nastavite razgovor. Potrebno je minimalno 2 razmjene poruka (trenutno: ' + roundCount + ').');
                    return;
                }
                const transcriptData = {
                    participantId: PARTICIPANT_ID,
                    group: 'control_cats_dogs',
                    transcript: fullTranscript,
                    roundCount: roundCount,
                    userPreference: USER_PREFERENCE,
                    initialReasoning: USER_REASONING,
                    completedAt: new Date().toISOString()
                };
                localStorage.setItem('chat_transcript', JSON.stringify(transcriptData));
                if (window.parent !== window) {
                    window.parent.postMessage({ type: 'chatComplete', data: transcriptData }, '*');
                }
                document.getElementById('chatContainer').innerHTML = '<div style="padding: 40px; text-align: center;"><h3>Hvala na sudjelovanju u razgovoru!</h3><p>Možete zatvoriti ovaj prozor.</p></div>';
                document.getElementById('userInput').style.display = 'none';
                document.getElementById('sendButton').style.display = 'none';
                document.getElementById('finishButton').style.display = 'none';
            }

            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('finishButton').addEventListener('click', finishConversation);
            document.getElementById('userInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') { sendMessage(); }
            });
            window.addEventListener('load', initializeConversation);
        })();
    </script>
</body>
</html>